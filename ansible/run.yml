---
- hosts: all
  become: true
  gather_facts: false

  tasks:

    # data directory (mainly for cache)
    - name: Creates data directory
      ansible.builtin.file:
        path: /mnt/data
        state: directory

    - name: Copy files to node
      copy:
        src: "{{item}}"
        dest: /root/deploy/
      loop:
        - ../docker-compose.yml
        - ../.env
        - ../nginx.conf

    - name: Copy json
      copy:
        src: "{{ item }}"
        dest: /root/deploy/json/
      with_fileglob: "../json/*.json"

    - name: Copy notebooks
      copy:
        src: "{{ item }}"
        dest: /root/deploy/notebooks/
      with_fileglob: "../notebooks/*.ipynb"

    - name: Copy NASA notebooks
      copy:
        src: "{{ item }}"
        dest: /root/deploy/notebooks/nasa/
      with_fileglob: "../notebooks/nasa/*.ipynb"

    - name: Remove all containers 
      ansible.builtin.shell: |
        docker rm -v -f $(docker ps -qa) || true
        # optional: remove all images
        # docker image remove -f $(sudo docker images -a -q) || true
      tags:
        - stop
        - restart

    # docker-compose up
    - name: docker-compose up
      community.docker.docker_compose:
        project_src: /root/deploy
        remove_orphans: true
        recreate: always
        pull: true
        restarted: true
      tags:
        - start
        - restart